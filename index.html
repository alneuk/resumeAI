<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ResumePulse helps students, graduates, and professionals create ATS-compliant resumes tailored to job descriptions.">
    <meta name="keywords" content="resume builder, CV creator, ATS resume, job application, professional resume">
    <meta name="author" content="ResumePulse">
    <title>ResumePulse | AI-Powered Resume Builder</title>
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --text-color: #1f2937;
            --light-text: #6b7280;
            --bg-color: #ffffff;
            --light-bg: #f9fafb;
            --dark-bg: #111827;
            --border-color: #e5e7eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }

        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: all 0.3s ease;
            margin: 0;
            padding: 0;
        }

        body.dark {
            --text-color: #f3f4f6;
            --light-text: #9ca3af;
            --bg-color: #111827;
            --light-bg: #1f2937;
            --border-color: #374151;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header Styles */
        .header {
            background-color: var(--light-bg);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .logo span {
            color: var(--primary-color);
        }

        .nav ul {
            display: flex;
            gap: 1.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 0;
            position: relative;
        }

        .nav a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn.primary:hover {
            background-color: var(--secondary-color);
        }

        .btn.secondary {
            background-color: var(--light-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn.secondary:hover {
            background-color: var(--border-color);
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
        }

        /* Main Content */
        .main-container {
            padding: 2rem 0;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Resume Builder Layout */
        .resume-builder {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }

        .form-column {
            flex: 1;
            padding-right: 2rem;
        }

        .preview-column {
            flex: 1;
            position: relative;
        }

        .suggestions-column {
            width: 300px;
            background-color: var(--light-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            position: sticky;
            top: 1rem;
            align-self: flex-start;
        }

        /* Form Styles */
        .form-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--light-text);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* AI Features */
        .ai-suggestions {
            border-left: 3px solid var(--primary-color);
            padding-left: 1rem;
            margin: 1rem 0;
        }

        .ai-loading {
            position: relative;
            opacity: 0.7;
        }

        .ai-loading::after {
            content: "Generating...";
            position: absolute;
            right: 1rem;
            color: var(--primary-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .suggestion-item {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: var(--light-bg);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-item:hover {
            transform: translateX(5px);
            background: var(--primary-color);
            color: white;
        }

        /* Resume Preview */
        .resume-template {
            background-color: white;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            min-height: 800px;
        }

        .resume-template.dark {
            background-color: #1e293b;
            color: white;
        }

        .resume-content {
            height: 100%;
        }

        .resume-name {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .resume-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .resume-section {
            margin-bottom: 1.5rem;
        }

        .resume-section h2 {
            font-size: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* ATS Feedback */
        .ats-feedback {
            margin-top: 2rem;
        }

        .ats-score {
            text-align: center;
            margin-bottom: 1rem;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: bold;
            font-size: 1.5rem;
            background: conic-gradient(var(--primary-color) 0%, var(--light-bg) 0%);
        }

        .feedback-list {
            background-color: var(--light-bg);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .feedback-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-item.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .feedback-item.warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        /* Skills Tags */
        .skills-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .skills-tags span {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }

        /* Experience/Education Items */
        .experience-item, .education-item {
            background: var(--light-bg);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
        }

        /* Templates Grid */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .template-card {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .template-card:hover {
            transform: translateY(-5px);
        }

        .template-preview {
            height: 350px;
            background-color: var(--light-bg);
        }

        /* Job Analyzer */
        .analyzer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .analyzer-input textarea {
            width: 100%;
            min-height: 300px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 1rem;
            margin-bottom: 1rem;
            resize: vertical;
        }

        .analyzer-results {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .keyword-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .keyword {
            padding: 0.5rem 1rem;
            background-color: var(--light-bg);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .keyword.important {
            background-color: var(--primary-color);
            color: white;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .toast.success {
            background-color: var(--success-color);
            color: white;
        }

        .toast.error {
            background-color: var(--error-color);
            color: white;
        }

        .toast.warning {
            background-color: var(--warning-color);
            color: white;
        }

        /* Resume Upload Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-color);
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        /* Responsive Layout */
        @media (max-width: 1024px) {
            .resume-builder {
                flex-direction: column;
            }
            
            .form-column,
            .preview-column {
                width: 100%;
                padding-right: 0;
            }
            
            .suggestions-column {
                width: 100%;
                position: static;
                margin-top: 2rem;
            }
            
            .analyzer-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header .container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav ul {
                justify-content: center;
            }
            
            .header-actions {
                justify-content: center;
            }
        }
    </style>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.8/mammoth.browser.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">Resume<span>Pulse</span></h1>
            <nav class="nav">
                <ul>
                    <li><a href="#" class="active" data-section="builder">Resume Builder</a></li>
                    <li><a href="#" data-section="templates">Templates</a></li>
                    <li><a href="#" data-section="analyzer">Job Analyzer</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <button id="dark-mode-toggle" class="icon-btn" aria-label="Toggle dark mode">🌓</button>
                <button id="reset-form" class="btn secondary">Reset</button>
                <button id="export-pdf" class="btn primary">Export PDF</button>
            </div>
        </div>
    </header>

    <main class="container main-container">
        <!-- Builder Section -->
        <section id="builder-section" class="section active">
            <div class="resume-builder">
                <!-- Form Column -->
                <div class="form-column">
                    <div class="form-tabs">
                        <button class="tab-btn active" data-tab="personal">Personal</button>
                        <button class="tab-btn" data-tab="summary">Summary</button>
                        <button class="tab-btn" data-tab="experience">Experience</button>
                        <button class="tab-btn" data-tab="education">Education</button>
                        <button class="tab-btn" data-tab="skills">Skills</button>
                        <button class="tab-btn" data-tab="custom">Custom</button>
                    </div>

                    <div class="tab-content active" id="personal-tab">
                        <h2>Personal Information</h2>
                        <div class="form-group">
                            <label for="full-name">Full Name</label>
                            <input type="text" id="full-name" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="job-title">Professional Title</label>
                            <input type="text" id="job-title" placeholder="Software Engineer">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" placeholder="john@example.com">
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phone" placeholder="(123) 456-7890">
                        </div>
                        <div class="form-group">
                            <label for="address">Address</label>
                            <input type="text" id="address" placeholder="City, State">
                        </div>
                        <div class="form-group">
                            <label for="linkedin">LinkedIn</label>
                            <input type="url" id="linkedin" placeholder="linkedin.com/in/username">
                        </div>
                        <div class="form-group">
                            <label for="portfolio">Portfolio/GitHub</label>
                            <input type="url" id="portfolio" placeholder="github.com/username">
                        </div>
                    </div>

                    <div class="tab-content" id="summary-tab">
                        <h2>Professional Summary</h2>
                        <div class="form-group">
                            <label for="professional-summary">Summary</label>
                            <textarea id="professional-summary" rows="6" placeholder="Experienced professional with X years in..."></textarea>
                        </div>
                        <button id="generate-summary" class="btn secondary">AI Generate Summary</button>
                        <div class="ai-suggestions">
                            <button class="btn secondary" onclick="improveSummaryWithAI()">
                                Improve with AI
                            </button>
                        </div>
                    </div>

                    <div class="tab-content" id="experience-tab">
                        <h2>Work Experience</h2>
                        <div id="experience-container">
                            <!-- Experience items will be added here -->
                        </div>
                        <button id="add-experience" class="btn secondary">+ Add Experience</button>
                        <div class="job-description-upload">
                            <h3>Optimize for Job Description</h3>
                            <textarea id="job-description" rows="4" placeholder="Paste job description here to get tailored suggestions..."></textarea>
                            <button id="analyze-job-description" class="btn secondary">Analyze & Suggest</button>
                            <h3>Or Upload Your Resume</h3>
                            <input type="file" id="resume-upload" accept=".pdf,.doc,.docx">
                            <button id="parse-resume" class="btn primary">Parse & Edit Resume</button>
                            <div id="upload-status"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="education-tab">
                        <h2>Education</h2>
                        <div id="education-container">
                            <!-- Education items will be added here -->
                        </div>
                        <button id="add-education" class="btn secondary">+ Add Education</button>
                    </div>

                    <div class="tab-content" id="skills-tab">
                        <h2>Skills</h2>
                        <div class="form-group">
                            <label for="skills-input">Add Skills (comma separated)</label>
                            <input type="text" id="skills-input" placeholder="JavaScript, Python, Project Management">
                            <button id="add-skills" class="btn secondary">Add Skills</button>
                        </div>
                        <div id="skills-list" class="skills-tags">
                            <!-- Skills will be added here -->
                        </div>
                        <div class="form-group">
                            <label for="certifications">Certifications</label>
                            <textarea id="certifications" rows="3" placeholder="AWS Certified Developer, Google Analytics Certification"></textarea>
                        </div>
                    </div>

                    <div class="tab-content" id="custom-tab">
                        <h2>Custom Sections</h2>
                        <div id="custom-sections-container">
                            <!-- Custom sections will be added here -->
                        </div>
                        <div class="form-group">
                            <label for="custom-section-name">Section Name</label>
                            <input type="text" id="custom-section-name" placeholder="Projects, Publications, etc.">
                        </div>
                        <div class="form-group">
                            <label for="custom-section-content">Content</label>
                            <textarea id="custom-section-content" rows="4" placeholder="Details about this section..."></textarea>
                        </div>
                        <button id="add-custom-section" class="btn secondary">+ Add Custom Section</button>
                    </div>
                </div>

                <!-- Preview Column -->
                <div class="preview-column">
                    <div class="preview-header">
                        <h2>Resume Preview</h2>
                        <div class="template-selector">
                            <label for="template-select">Template:</label>
                            <select id="template-select">
                                <option value="classic">Classic</option>
                                <option value="modern">Modern</option>
                                <option value="executive">Executive</option>
                                <option value="creative">Creative</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="resume-preview" class="resume-template classic">
                        <!-- Resume preview will be rendered here -->
                    </div>

                    <div class="ats-feedback">
                        <h3>ATS Optimization</h3>
                        <div class="ats-score">
                            <div class="score-circle">
                                <span id="ats-score-value">0</span>%
                            </div>
                            <p>ATS Compatibility Score</p>
                        </div>
                        <div id="ats-feedback-list" class="feedback-list">
                            <!-- ATS feedback will be added here -->
                        </div>
                    </div>
                </div>

                <!-- AI Suggestions Panel -->
                <div class="suggestions-column">
                    <div class="suggestions-header">
                        <h2>AI Suggestions</h2>
                        <button id="close-suggestions" class="icon-btn" aria-label="Close suggestions">×</button>
                    </div>
                    <div id="suggestions-content">
                        <div class="suggestion-placeholder">
                            <p>Paste a job description to get tailored suggestions</p>
                            <p>Or try these AI-powered features:</p>
                            <ul>
                                <li>Generate professional summary</li>
                                <li>Enhance work experience bullets</li>
                                <li>Optimize for ATS keywords</li>
                                <li>Match to job descriptions</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Resume Edit Modal -->
        <div id="resume-edit-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Parsed Resume</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="resume-edit-form">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="edit-full-name">
                        </div>
                        <div class="form-group">
                            <label>Professional Title</label>
                            <input type="text" id="edit-job-title">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="edit-email">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="edit-phone">
                        </div>
                        <div class="form-group">
                            <label>Professional Summary</label>
                            <textarea id="edit-summary" rows="4"></textarea>
                        </div>
                        <div id="edit-experience-container">
                            <!-- Parsed experience items will be added here -->
                        </div>
                        <div id="edit-education-container">
                            <!-- Parsed education items will be added here -->
                        </div>
                        <div class="form-group">
                            <label>Skills (comma separated)</label>
                            <textarea id="edit-skills" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="save-resume-edits" class="btn primary">Save Changes</button>
                    <button class="btn secondary close-modal">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Templates Section -->
        <section id="templates-section" class="section">
            <h2>Choose a Template</h2>
            <div class="templates-grid">
                <div class="template-card" data-template="classic">
                    <div class="template-preview classic"></div>
                    <h3>Classic</h3>
                    <p>Traditional layout with clear sections</p>
                    <button class="btn secondary select-template">Select</button>
                </div>
                <div class="template-card" data-template="modern">
                    <div class="template-preview modern"></div>
                    <h3>Modern</h3>
                    <p>Clean design with sidebar</p>
                    <button class="btn secondary select-template">Select</button>
                </div>
                <div class="template-card" data-template="executive">
                    <div class="template-preview executive"></div>
                    <h3>Executive</h3>
                    <p>Professional two-column layout</p>
                    <button class="btn secondary select-template">Select</button>
                </div>
                <div class="template-card" data-template="creative">
                    <div class="template-preview creative"></div>
                    <h3>Creative</h3>
                    <p>Modern design with color accents</p>
                    <button class="btn secondary select-template">Select</button>
                </div>
            </div>
        </section>

        <!-- Analyzer Section -->
        <section id="analyzer-section" class="section">
            <h2>Job Description Analyzer</h2>
            <div class="analyzer-container">
                <div class="analyzer-input">
                    <textarea id="analyzer-job-description" rows="10" placeholder="Paste the job description you want to analyze..."></textarea>
                    <button id="analyze-description" class="btn primary">Analyze Job Description</button>
                </div>
                <div class="analyzer-results">
                    <div class="results-placeholder">
                        <p>Results will appear here after analysis.</p>
                        <p>We'll identify:</p>
                        <ul>
                            <li>Key skills and qualifications</li>
                            <li>Important keywords for ATS</li>
                            <li>Action verbs and phrases</li>
                            <li>Suggested resume improvements</li>
                        </ul>
                    </div>
                    <div id="keyword-results" class="hidden">
                        <h3>Top Keywords</h3>
                        <div class="keyword-cloud"></div>
                        <h3>Suggested Skills</h3>
                        <div class="suggested-skills"></div>
                        <h3>Action Verbs</h3>
                        <div class="action-verbs"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>ResumePulse helps you create ATS-compliant resumes tailored to your dream job.</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Contact</a>
            </div>
            <p class="copyright">© 2023 ResumePulse. All rights reserved.</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // Resume Builder Application - Complete Implementation
        (() => {
            // DOM Elements Cache
            const els = {
                darkModeToggle: document.getElementById('dark-mode-toggle'),
                exportPdfBtn: document.getElementById('export-pdf'),
                resetFormBtn: document.getElementById('reset-form'),
                navLinks: document.querySelectorAll('.nav a'),
                sections: document.querySelectorAll('.section'),
                tabButtons: document.querySelectorAll('.tab-btn'),
                tabContents: document.querySelectorAll('.tab-content'),
                templateSelect: document.getElementById('template-select'),
                resumePreview: document.getElementById('resume-preview'),
                addExperienceBtn: document.getElementById('add-experience'),
                experienceContainer: document.getElementById('experience-container'),
                addEducationBtn: document.getElementById('add-education'),
                educationContainer: document.getElementById('education-container'),
                skillsInput: document.getElementById('skills-input'),
                addSkillsBtn: document.getElementById('add-skills'),
                skillsList: document.getElementById('skills-list'),
                addCustomSectionBtn: document.getElementById('add-custom-section'),
                customSectionsContainer: document.getElementById('custom-sections-container'),
                generateSummaryBtn: document.getElementById('generate-summary'),
                analyzejobDescriptionBtn: document.getElementById('analyze-job-description'),
                jobDescriptionTextarea: document.getElementById('job-description'),
                suggestionsPanel: document.querySelector('.suggestions-column'),
                closeSuggestionsBtn: document.getElementById('close-suggestions'),
                templateCards: document.querySelectorAll('.template-card'),
                analyzeDescriptionBtn: document.getElementById('analyze-description'),
                analyzerJobDescTextarea: document.getElementById('analyzer-job-description'),
                keywordResults: document.getElementById('keyword-results'),
                resumeUploadInput: document.getElementById('resume-upload'),
                parseResumeBtn: document.getElementById('parse-resume'),
                uploadStatus: document.getElementById('upload-status'),
                atsScoreValue: document.getElementById('ats-score-value'),
                atsFeedbackList: document.getElementById('ats-feedback-list'),
                resumeEditModal: document.getElementById('resume-edit-modal'),
                editFullName: document.getElementById('edit-full-name'),
                editJobTitle: document.getElementById('edit-job-title'),
                editEmail: document.getElementById('edit-email'),
                editPhone: document.getElementById('edit-phone'),
                editSummary: document.getElementById('edit-summary'),
                editExperienceContainer: document.getElementById('edit-experience-container'),
                editEducationContainer: document.getElementById('edit-education-container'),
                editSkills: document.getElementById('edit-skills'),
                saveResumeEditsBtn: document.getElementById('save-resume-edits'),
                closeModalBtns: document.querySelectorAll('.close-modal')
            };

            // Application State
            let state = {
                activeSection: 'builder',
                activeTab: 'personal',
                isDarkMode: localStorage.getItem('darkMode') === 'true',
                isParsedResume: false,
                aiApiKey: localStorage.getItem('aiApiKey') || '',
                parsedResumeData: null
            };

            // Resume Data Model
            let resumeData = (() => {
                const defaultData = {
                    version: 1.5,
                    personal: {
                        fullName: '',
                        jobTitle: '',
                        email: '',
                        phone: '',
                        address: '',
                        linkedin: '',
                        portfolio: ''
                    },
                    summary: '',
                    experiences: [],
                    education: [],
                    skills: [],
                    certifications: '',
                    customSections: []
                };

                try {
                    const saved = JSON.parse(localStorage.getItem('resumeData')) || defaultData;
                    return saved.version === defaultData.version ? saved : defaultData;
                } catch {
                    return defaultData;
                }
            })();

            // Utility Functions
            const debounce = (fn, delay = 300) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => fn.apply(this, args), delay);
                };
            };

            const createDelegate = (container, event, selector, handler) => {
                container.addEventListener(event, e => {
                    if (e.target.matches(selector)) handler(e);
                });
            };

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            };

            // Modal Functions
            function openModal() {
                els.resumeEditModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                els.resumeEditModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            // AI Integration
            const generateWithAI = async (prompt) => {
                if (!state.aiApiKey) {
                    showToast('Please set your AI API key first', 'error');
                    return null;
                }

                try {
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${state.aiApiKey}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [{
                                role: "user",
                                content: prompt
                            }],
                            temperature: 0.7
                        })
                    });
                    
                    const data = await response.json();
                    return data.choices[0]?.message?.content || null;
                } catch (error) {
                    console.error('AI Error:', error);
                    showToast('AI service error', 'error');
                    return null;
                }
            };

            // Core Application Functions
            function init() {
                loadFromStorage();
                setupEventListeners();
                populateForm();
                updateUI();
                updateResumePreview();
                updateAtsScore();
            }

            function setupEventListeners() {
                // Theme Toggle
                els.darkModeToggle.addEventListener('click', toggleDarkMode);

                // Navigation
                createDelegate(document.querySelector('.nav'), 'click', 'a[data-section]', e => {
                    e.preventDefault();
                    state.activeSection = e.target.dataset.section;
                    updateUI();
                });

                // Form Tabs
                createDelegate(document.querySelector('.form-tabs'), 'click', '.tab-btn', e => {
                    state.activeTab = e.target.dataset.tab;
                    updateUI();
                });

                // Template Handling
                els.templateSelect.addEventListener('change', updateTemplate);
                els.templateCards.forEach(card => {
                    card.addEventListener('click', e => {
                        if (e.target.classList.contains('select-template')) {
                            els.templateSelect.value = card.dataset.template;
                            updateTemplate();
                            state.activeSection = 'builder';
                            updateUI();
                        }
                    });
                });

                // Form Inputs
                const bindInput = (id, path) => {
                    const el = document.getElementById(id);
                    el.addEventListener('input', debounce(e => {
                        setNestedValue(resumeData, path, e.target.value);
                        updateResumePreview();
                        saveToStorage();
                    }));
                };

                bindInput('full-name', 'personal.fullName');
                bindInput('job-title', 'personal.jobTitle');
                bindInput('email', 'personal.email');
                bindInput('phone', 'personal.phone');
                bindInput('address', 'personal.address');
                bindInput('linkedin', 'personal.linkedin');
                bindInput('portfolio', 'personal.portfolio');
                bindInput('professional-summary', 'summary');
                bindInput('certifications', 'certifications');

                // Buttons
                els.addExperienceBtn.addEventListener('click', () => addExperience());
                els.addEducationBtn.addEventListener('click', () => addEducation());
                els.addSkillsBtn.addEventListener('click', addSkills);
                els.skillsInput.addEventListener('keypress', e => e.key === 'Enter' && addSkills());
                els.addCustomSectionBtn.addEventListener('click', addCustomSection);
                els.generateSummaryBtn.addEventListener('click', generateAISummary);
                els.analyzejobDescriptionBtn.addEventListener('click', analyzeJobDescription);
                els.closeSuggestionsBtn.addEventListener('click', () => els.suggestionsPanel.style.display = 'none');
                els.analyzeDescriptionBtn.addEventListener('click', analyzeJobDescriptionForKeywords);
                els.parseResumeBtn.addEventListener('click', handleResumeUpload);
                els.exportPdfBtn.addEventListener('click', exportToPDF);
                els.resetFormBtn.addEventListener('click', resetAll);

                // Modal Events
                els.closeModalBtns.forEach(btn => {
                    btn.addEventListener('click', closeModal);
                });

                els.saveResumeEditsBtn.addEventListener('click', saveResumeEdits);

                // Close modal when clicking outside
                els.resumeEditModal.addEventListener('click', (e) => {
                    if (e.target === els.resumeEditModal) {
                        closeModal();
                    }
                });
            }

            // Data Management
            function setNestedValue(obj, path, value) {
                const keys = path.split('.');
                let current = obj;
                for (let i = 0; i < keys.length - 1; i++) {
                    current = current[keys[i]] = current[keys[i]] || {};
                }
                current[keys[keys.length - 1]] = value;
            }

            function saveToStorage() {
                localStorage.setItem('resumeData', JSON.stringify(resumeData));
                localStorage.setItem('darkMode', state.isDarkMode);
                localStorage.setItem('selectedTemplate', els.templateSelect.value);
                localStorage.setItem('aiApiKey', state.aiApiKey);
            }

            function loadFromStorage() {
                const savedDarkMode = localStorage.getItem('darkMode') === 'true';
                if (savedDarkMode) {
                    document.body.classList.add('dark');
                    state.isDarkMode = true;
                }

                const savedTemplate = localStorage.getItem('selectedTemplate');
                if (savedTemplate) {
                    els.templateSelect.value = savedTemplate;
                }

                const savedApiKey = localStorage.getItem('aiApiKey');
                if (savedApiKey) {
                    state.aiApiKey = savedApiKey;
                }
            }

            function resetAll() {
                if (!confirm('Are you sure you want to reset all data?')) return;

                resumeData = {
                    version: 1.5,
                    personal: { fullName: '', jobTitle: '', email: '', phone: '', address: '', linkedin: '', portfolio: '' },
                    summary: '',
                    experiences: [],
                    education: [],
                    skills: [],
                    certifications: '',
                    customSections: []
                };

                document.querySelectorAll('input, textarea').forEach(el => el.value = '');
                els.experienceContainer.innerHTML = '';
                els.educationContainer.innerHTML = '';
                els.skillsList.innerHTML = '';
                els.customSectionsContainer.innerHTML = '';
                els.resumeUploadInput.value = '';
                els.resumePreview.innerHTML = '';
                els.atsScoreValue.textContent = '0';
                els.atsFeedbackList.innerHTML = '';

                state.activeSection = 'builder';
                state.activeTab = 'personal';
                state.isParsedResume = false;

                updateUI();
                saveToStorage();
                showToast('All data has been reset');
            }

            // UI Updates
            function updateUI() {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(`${state.activeSection}-section`).classList.add('active');

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.tab-btn[data-tab="${state.activeTab}"]`).classList.add('active');

                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById(`${state.activeTab}-tab`).classList.add('active');

                document.querySelector('.resume-builder').classList.toggle('parsed', state.isParsedResume);
            }

            function toggleDarkMode() {
                state.isDarkMode = !state.isDarkMode;
                document.body.classList.toggle('dark', state.isDarkMode);
                saveToStorage();
            }

            // Resume Preview
            function updateTemplate() {
                els.resumePreview.className = `resume-template ${els.templateSelect.value}`;
                updateResumePreview();
            }

            function updateResumePreview() {
                const template = els.templateSelect.value;
                const previewContent = generatePreviewContent();
                
                els.resumePreview.innerHTML = `
                    <div class="resume-content ${template}">
                        ${previewContent.header}
                        ${previewContent.summary}
                        ${previewContent.experience}
                        ${previewContent.education}
                        ${previewContent.skills}
                        ${previewContent.custom}
                    </div>
                `;
                updateAtsScore();
            }

            function generatePreviewContent() {
                return {
                    header: `
                        <header class="resume-header">
                            <h1 class="resume-name">${resumeData.personal.fullName || 'Your Name'}</h1>
                            <p class="resume-title">${resumeData.personal.jobTitle || 'Professional Title'}</p>
                            <div class="contact-info">
                                ${resumeData.personal.email ? `<div>📧 ${resumeData.personal.email}</div>` : ''}
                                ${resumeData.personal.phone ? `<div>📱 ${resumeData.personal.phone}</div>` : ''}
                                ${resumeData.personal.linkedin ? `<div>🔗 ${resumeData.personal.linkedin}</div>` : ''}
                            </div>
                        </header>
                    `,
                    summary: resumeData.summary ? `
                        <section class="summary-section">
                            <h2>Professional Summary</h2>
                            <p>${resumeData.summary}</p>
                        </section>
                    ` : '',
                    experience: resumeData.experiences.length > 0 ? `
                        <section class="experience-section">
                            <h2>Work Experience</h2>
                            ${resumeData.experiences.map(exp => `
                                <div class="experience-item">
                                    <h3>${exp.jobTitle || 'Position'}</h3>
                                    <div class="meta">
                                        ${exp.company ? `<span>${exp.company}</span>` : ''}
                                        ${exp.dates ? `<span>${exp.dates}</span>` : ''}
                                    </div>
                                    ${exp.description ? `<div class="description">${exp.description.replace(/\n/g, '<br>')}</div>` : ''}
                                </div>
                            `).join('')}
                        </section>
                    ` : '',
                    education: resumeData.education.length > 0 ? `
                        <section class="education-section">
                            <h2>Education</h2>
                            ${resumeData.education.map(edu => `
                                <div class="education-item">
                                    <h3>${edu.degree || 'Degree'}</h3>
                                    <div class="meta">
                                        ${edu.institution ? `<span>${edu.institution}</span>` : ''}
                                        ${edu.dates ? `<span>${edu.dates}</span>` : ''}
                                    </div>
                                    ${edu.achievements ? `<div class="achievements">${edu.achievements.replace(/\n/g, '<br>')}</div>` : ''}
                                </div>
                            `).join('')}
                        </section>
                    ` : '',
                    skills: resumeData.skills.length > 0 ? `
                        <section class="skills-section">
                            <h2>Skills</h2>
                            <div class="skills-list">
                                ${resumeData.skills.map(skill => `<span>${skill}</span>`).join('')}
                            </div>
                        </section>
                    ` : '',
                    custom: resumeData.customSections.length > 0 ? `
                        <section class="custom-section">
                            ${resumeData.customSections.map(section => `
                                <div class="custom-item">
                                    <h3>${section.name || 'Section Title'}</h3>
                                    <div>${section.content.replace(/\n/g, '<br>')}</div>
                                </div>
                            `).join('')}
                        </section>
                    ` : ''
                };
            }

            // ATS Scoring
            function updateAtsScore() {
                const { score, feedback } = calculateAtsScore();
                els.atsScoreValue.textContent = score;
                els.atsFeedbackList.innerHTML = feedback.map(item => `
                    <div class="feedback-item ${item.type}">
                        <span class="icon">${item.icon}</span>
                        ${item.message}
                    </div>
                `).join('');

                document.querySelector('.score-circle').style.background = 
                    `conic-gradient(var(--primary-color) ${score}%, var(--light-bg) ${score}% 100%)`;
            }

            function calculateAtsScore() {
                const checks = [
                    { test: () => !!resumeData.personal.fullName, score: 5, fail: 'Missing full name' },
                    { test: () => !!resumeData.personal.email, score: 5, fail: 'Missing email' },
                    { test: () => resumeData.experiences.length > 0, score: 15, fail: 'Missing experience' },
                    { test: () => resumeData.education.length > 0, score: 10, fail: 'Missing education' },
                    { test: () => resumeData.skills.length >= 5, score: 20, warn: 'Add more skills (5+ recommended)' },
                    { test: () => countKeywords() >= 10, score: 30, warn: 'Add more keywords' },
                    { test: () => resumeData.summary.length > 0, score: 15, warn: 'Add professional summary' }
                ];

                return checks.reduce((acc, check) => {
                    if (check.test()) {
                        acc.score += check.score;
                    } else {
                        acc.feedback.push({
                            type: check.fail ? 'error' : 'warning',
                            icon: check.fail ? '❌' : '⚠️',
                            message: check.fail || check.warn
                        });
                    }
                    return acc;
                }, { score: 0, feedback: [] });
            }

            function countKeywords() {
                const text = [
                    resumeData.summary,
                    ...resumeData.experiences.map(exp => exp.description),
                    resumeData.skills.join(' ')
                ].join(' ').toLowerCase();

                const keywords = [
                    'managed', 'developed', 'led', 'created', 'improved',
                    'increased', 'reduced', 'optimized', 'designed', 'implemented',
                    'achieved', 'built', 'collaborated', 'delivered', 'enhanced',
                    'established', 'facilitated', 'generated', 'initiated', 'launched'
                ];

                return keywords.filter(word => text.includes(word)).length;
            }

            // Resume Parsing and Editing
            async function handleResumeUpload() {
                const file = els.resumeUploadInput.files[0];
                if (!file) return showToast('Please select a file first', 'error');

                try {
                    els.uploadStatus.textContent = 'Processing resume...';
                    const parsedData = await parseResumeFile(file);
                    
                    // Store parsed data for editing
                    state.parsedResumeData = parsedData;
                    
                    // Populate the edit modal
                    populateEditModal(parsedData);
                    
                    // Open the edit modal
                    openModal();
                    
                    showToast('Resume parsed successfully!');
                } catch (error) {
                    showToast('Error parsing resume. Please try another file.', 'error');
                    console.error('Parsing error:', error);
                } finally {
                    els.uploadStatus.textContent = '';
                }
            }

            function populateEditModal(parsedData) {
                // Basic info
                els.editFullName.value = parsedData.personal_info?.name || '';
                els.editJobTitle.value = parsedData.personal_info?.job_title || '';
                els.editEmail.value = parsedData.personal_info?.email || '';
                els.editPhone.value = parsedData.personal_info?.phone || '';
                els.editSummary.value = parsedData.summary || '';
                
                // Skills
                els.editSkills.value = parsedData.skills?.join(', ') || '';
                
                // Experience
                els.editExperienceContainer.innerHTML = '';
                if (parsedData.experience?.length > 0) {
                    parsedData.experience.forEach((exp, index) => {
                        const expHtml = `
                            <div class="experience-item" data-index="${index}">
                                <div class="form-group">
                                    <label>Job Title</label>
                                    <input type="text" value="${exp.job_title || ''}" class="edit-exp-job-title">
                                </div>
                                <div class="form-group">
                                    <label>Company</label>
                                    <input type="text" value="${exp.company || ''}" class="edit-exp-company">
                                </div>
                                <div class="form-group">
                                    <label>Dates</label>
                                    <input type="text" value="${exp.dates || ''}" class="edit-exp-dates">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea class="edit-exp-description">${exp.description || ''}</textarea>
                                </div>
                            </div>
                        `;
                        els.editExperienceContainer.insertAdjacentHTML('beforeend', expHtml);
                    });
                }
                
                // Education
                els.editEducationContainer.innerHTML = '';
                if (parsedData.education?.length > 0) {
                    parsedData.education.forEach((edu, index) => {
                        const eduHtml = `
                            <div class="education-item" data-index="${index}">
                                <div class="form-group">
                                    <label>Degree</label>
                                    <input type="text" value="${edu.degree || ''}" class="edit-edu-degree">
                                </div>
                                <div class="form-group">
                                    <label>Institution</label>
                                    <input type="text" value="${edu.institution || ''}" class="edit-edu-institution">
                                </div>
                                <div class="form-group">
                                    <label>Dates</label>
                                    <input type="text" value="${edu.dates || ''}" class="edit-edu-dates">
                                </div>
                                <div class="form-group">
                                    <label>Achievements</label>
                                    <textarea class="edit-edu-achievements">${edu.achievements || ''}</textarea>
                                </div>
                            </div>
                        `;
                        els.editEducationContainer.insertAdjacentHTML('beforeend', eduHtml);
                    });
                }
            }

            function saveResumeEdits() {
                // Update basic info
                resumeData.personal.fullName = els.editFullName.value;
                resumeData.personal.jobTitle = els.editJobTitle.value;
                resumeData.personal.email = els.editEmail.value;
                resumeData.personal.phone = els.editPhone.value;
                resumeData.summary = els.editSummary.value;
                
                // Update skills
                resumeData.skills = els.editSkills.value.split(',').map(s => s.trim()).filter(s => s);
                
                // Update experiences
                resumeData.experiences = [];
                const expItems = els.editExperienceContainer.querySelectorAll('.experience-item');
                expItems.forEach(item => {
                    resumeData.experiences.push({
                        jobTitle: item.querySelector('.edit-exp-job-title').value,
                        company: item.querySelector('.edit-exp-company').value,
                        dates: item.querySelector('.edit-exp-dates').value,
                        description: item.querySelector('.edit-exp-description').value
                    });
                });
                
                // Update education
                resumeData.education = [];
                const eduItems = els.editEducationContainer.querySelectorAll('.education-item');
                eduItems.forEach(item => {
                    resumeData.education.push({
                        degree: item.querySelector('.edit-edu-degree').value,
                        institution: item.querySelector('.edit-edu-institution').value,
                        dates: item.querySelector('.edit-edu-dates').value,
                        achievements: item.querySelector('.edit-edu-achievements').value
                    });
                });
                
                // Update the form and preview
                populateForm();
                updateResumePreview();
                saveToStorage();
                
                // Close the modal
                closeModal();
                
                showToast('Resume edits saved successfully!');
                state.isParsedResume = true;
                updateUI();
            }

            async function parseResumeFile(file) {
                try {
                    let text = '';
                    
                    if (file.type === 'application/pdf') {
                        // Initialize PDF.js worker
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                        
                        // Load the PDF file
                        const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                        const pdf = await loadingTask.promise;
                        
                        // Extract text from each page
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(' ') + '\n';
                        }
                    } 
                    else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                             file.name.endsWith('.docx')) {
                        // Handle DOCX files
                        const result = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
                        text = result.value;
                    }
                    else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                        // Handle plain text files
                        text = await file.text();
                    }
                    else {
                        throw new Error('Unsupported file format. Please upload a PDF, DOCX, or TXT file.');
                    }

                    // Clean up the extracted text
                    text = cleanText(text);

                    // Use AI for advanced parsing
                    const prompt = `Parse this resume text into structured JSON format with these fields: 
                        personal_info (object with name, email, phone, job_title, etc.), 
                        summary (string), 
                        experience (array of objects with job_title, company, dates, description), 
                        education (array of objects with degree, institution, dates, achievements), 
                        skills (array of strings), 
                        certifications (string). 
                        Return only valid JSON without any additional text or markdown:\n\n${text}`;

                    const parsed = await generateWithAI(prompt);
                    if (!parsed) throw new Error('AI parsing failed');

                    // Try to parse the JSON response
                    try {
                        return JSON.parse(parsed);
                    } catch (e) {
                        console.error('Failed to parse AI response:', parsed);
                        throw new Error('Failed to parse AI response. The response was not valid JSON.');
                    }
                } catch (error) {
                    console.error('Parsing error:', error);
                    showToast(`Error parsing resume: ${error.message}`, 'error');
                    throw error;
                }
            }

            function cleanText(text) {
                // Remove excessive whitespace and line breaks
                return text.replace(/\s+/g, ' ').trim();
            }

            function populateForm() {
                document.getElementById('full-name').value = resumeData.personal.fullName || '';
                document.getElementById('job-title').value = resumeData.personal.jobTitle || '';
                document.getElementById('email').value = resumeData.personal.email || '';
                document.getElementById('phone').value = resumeData.personal.phone || '';
                document.getElementById('address').value = resumeData.personal.address || '';
                document.getElementById('linkedin').value = resumeData.personal.linkedin || '';
                document.getElementById('portfolio').value = resumeData.personal.portfolio || '';
                document.getElementById('professional-summary').value = resumeData.summary || '';
                document.getElementById('certifications').value = resumeData.certifications || '';

                els.experienceContainer.innerHTML = '';
                resumeData.experiences.forEach(exp => addExperience(exp));

                els.educationContainer.innerHTML = '';
                resumeData.education.forEach(edu => addEducation(edu));

                els.skillsList.innerHTML = '';
                resumeData.skills.forEach(skill => addSkillTag(skill));

                els.customSectionsContainer.innerHTML = '';
                resumeData.customSections.forEach(section => addCustomSection(section));
            }

            // Dynamic Section Management
            function addExperience(data = {}) {
                const id = data.id || Date.now();
                const experience = {
                    id,
                    jobTitle: data.jobTitle || '',
                    company: data.company || '',
                    dates: data.dates || '',
                    description: data.description || ''
                };

                const html = `
                    <div class="experience-item" data-id="${id}">
                        <div class="form-group">
                            <label>Job Title</label>
                            <input type="text" value="${experience.jobTitle}" 
                                   data-field="jobTitle" class="experience-input">
                        </div>
                        <div class="form-group">
                            <label>Company</label>
                            <input type="text" value="${experience.company}" 
                                   data-field="company" class="experience-input">
                        </div>
                        <div class="form-group">
                            <label>Dates (e.g., 2020 - Present)</label>
                            <input type="text" value="${experience.dates}" 
                                   data-field="dates" class="experience-input">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea data-field="description" 
                                     class="experience-input">${experience.description}</textarea>
                        </div>
                        <div class="experience-actions">
                            <button class="btn secondary" onclick="enhanceExperienceWithAI(this)">
                                Enhance with AI
                            </button>
                            <button class="btn remove-btn" data-action="remove-experience" data-id="${id}">Remove</button>
                        </div>
                    </div>
                `;

                els.experienceContainer.insertAdjacentHTML('beforeend', html);
                if (!data.id) {
                    resumeData.experiences.push(experience);
                }
                addExperienceListeners(id);
                saveToStorage();
            }

            function addEducation(data = {}) {
                const id = data.id || Date.now();
                const education = {
                    id,
                    degree: data.degree || '',
                    institution: data.institution || '',
                    dates: data.dates || '',
                    achievements: data.achievements || ''
                };

                const html = `
                    <div class="education-item" data-id="${id}">
                        <div class="form-group">
                            <label>Degree</label>
                            <input type="text" value="${education.degree}" 
                                   data-field="degree" class="education-input">
                        </div>
                        <div class="form-group">
                            <label>Institution</label>
                            <input type="text" value="${education.institution}" 
                                   data-field="institution" class="education-input">
                        </div>
                        <div class="form-group">
                            <label>Dates (e.g., 2016 - 2020)</label>
                            <input type="text" value="${education.dates}" 
                                   data-field="dates" class="education-input">
                        </div>
                        <div class="form-group">
                            <label>Achievements</label>
                            <textarea data-field="achievements" 
                                      class="education-input">${education.achievements}</textarea>
                        </div>
                        <button class="btn remove-btn" data-action="remove-education" data-id="${id}">Remove</button>
                    </div>
                `;

                els.educationContainer.insertAdjacentHTML('beforeend', html);
                if (!data.id) {
                    resumeData.education.push(education);
                }
                addEducationListeners(id);
                saveToStorage();
            }

            function addSkillTag(skill) {
                const tag = document.createElement('span');
                tag.className = 'skill-tag';
                tag.innerHTML = `
                    ${skill}
                    <span class="remove-skill" onclick="removeSkill('${skill}')">×</span>
                `;
                els.skillsList.appendChild(tag);
            }

            function addCustomSection(data = {}) {
                const id = data.id || Date.now();
                const section = {
                    id,
                    name: data.name || '',
                    content: data.content || ''
                };

                const html = `
                    <div class="custom-section-item" data-id="${id}">
                        <div class="form-group">
                            <label>Section Name</label>
                            <input type="text" value="${section.name}" 
                                   data-field="name" class="custom-section-input">
                        </div>
                        <div class="form-group">
                            <label>Content</label>
                            <textarea data-field="content" 
                                      class="custom-section-input">${section.content}</textarea>
                        </div>
                        <button class="btn remove-btn" data-action="remove-custom-section" data-id="${id}">Remove</button>
                    </div>
                `;

                els.customSectionsContainer.insertAdjacentHTML('beforeend', html);
                if (!data.id) {
                    resumeData.customSections.push(section);
                }
                addCustomSectionListeners(id);
                saveToStorage();
            }

            // Event Listeners for Dynamic Content
            function addExperienceListeners(id) {
                const experienceEl = document.querySelector(`.experience-item[data-id="${id}"]`);
                if (!experienceEl) return;

                experienceEl.querySelectorAll('input, textarea').forEach(input => {
                    input.addEventListener('input', debounce(e => {
                        const field = e.target.dataset.field;
                        const experience = resumeData.experiences.find(exp => exp.id === id);
                        if (experience) {
                            experience[field] = e.target.value;
                            updateResumePreview();
                            saveToStorage();
                        }
                    }));
                });

                const removeBtn = experienceEl.querySelector('[data-action="remove-experience"]');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        resumeData.experiences = resumeData.experiences.filter(exp => exp.id !== id);
                        experienceEl.remove();
                        updateResumePreview();
                        saveToStorage();
                    });
                }
            }

            function addEducationListeners(id) {
                const educationEl = document.querySelector(`.education-item[data-id="${id}"]`);
                if (!educationEl) return;

                educationEl.querySelectorAll('input, textarea').forEach(input => {
                    input.addEventListener('input', debounce(e => {
                        const field = e.target.dataset.field;
                        const education = resumeData.education.find(edu => edu.id === id);
                        if (education) {
                            education[field] = e.target.value;
                            updateResumePreview();
                            saveToStorage();
                        }
                    }));
                });

                const removeBtn = educationEl.querySelector('[data-action="remove-education"]');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        resumeData.education = resumeData.education.filter(edu => edu.id !== id);
                        educationEl.remove();
                        updateResumePreview();
                        saveToStorage();
                    });
                }
            }

            function addCustomSectionListeners(id) {
                const sectionEl = document.querySelector(`.custom-section-item[data-id="${id}"]`);
                if (!sectionEl) return;

                sectionEl.querySelectorAll('input, textarea').forEach(input => {
                    input.addEventListener('input', debounce(e => {
                        const field = e.target.dataset.field;
                        const section = resumeData.customSections.find(sec => sec.id === id);
                        if (section) {
                            section[field] = e.target.value;
                            updateResumePreview();
                            saveToStorage();
                        }
                    }));
                });

                const removeBtn = sectionEl.querySelector('[data-action="remove-custom-section"]');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        resumeData.customSections = resumeData.customSections.filter(sec => sec.id !== id);
                        sectionEl.remove();
                        updateResumePreview();
                        saveToStorage();
                    });
                }
            }

            function addSkills() {
                const skillsText = els.skillsInput.value.trim();
                if (!skillsText) return;

                const newSkills = skillsText.split(',')
                    .map(skill => skill.trim())
                    .filter(skill => skill.length > 0);

                newSkills.forEach(skill => {
                    if (!resumeData.skills.includes(skill)) {
                        resumeData.skills.push(skill);
                        addSkillTag(skill);
                    }
                });

                els.skillsInput.value = '';
                updateResumePreview();
                saveToStorage();
            }

            // AI Features
            async function generateAISummary() {
                const experienceText = resumeData.experiences
                    .map(exp => `${exp.jobTitle} at ${exp.company}: ${exp.description}`)
                    .join('\n');

                const prompt = `Generate a professional resume summary for a ${resumeData.personal.jobTitle || 'professional'} with these key points:
- Skills: ${resumeData.skills.join(', ') || 'Not specified'}
- Experience highlights:
${experienceText || 'No experience listed'}

Make the summary concise (3-4 sentences), professional, and optimized for applicant tracking systems. Focus on achievements and quantifiable results where possible.`;

                els.generateSummaryBtn.classList.add('ai-loading');
                const summary = await generateWithAI(prompt);
                els.generateSummaryBtn.classList.remove('ai-loading');

                if (summary) {
                    resumeData.summary = summary;
                    document.getElementById('professional-summary').value = summary;
                    updateResumePreview();
                    saveToStorage();
                    showToast('AI summary generated successfully!');
                }
            }

            async function analyzeJobDescription() {
                const jobDesc = els.jobDescriptionTextarea.value.trim();
                if (!jobDesc) return showToast('Please enter a job description', 'error');

                const resumeText = [
                    resumeData.summary,
                    ...resumeData.experiences.map(exp => exp.description),
                    resumeData.skills.join(', ')
                ].join('\n');

                const prompt = `Analyze this job description and compare it to the following resume content. Provide specific recommendations to optimize the resume for this job in JSON format with these fields:
- missing_skills: Array of important skills from the job description that are missing from the resume
- suggested_keywords: Array of keywords to incorporate
- action_verbs: Array of powerful action verbs to use
- general_advice: String with overall optimization advice

Job Description:
${jobDesc}

Resume Content:
${resumeText}`;

                els.analyzejobDescriptionBtn.classList.add('ai-loading');
                const analysis = await generateWithAI(prompt);
                els.analyzejobDescriptionBtn.classList.remove('ai-loading');

                try {
                    const { missing_skills, suggested_keywords, action_verbs, general_advice } = JSON.parse(analysis);
                    
                    els.suggestionsContent.innerHTML = `
                        <div class="suggestion-section">
                            <h3>Missing Skills</h3>
                            ${missing_skills.map(skill => `
                                <div class="suggestion-item" onclick="addSkill('${skill.replace("'", "\\'")}')">
                                    ${skill} <span class="add-icon">+</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="suggestion-section">
                            <h3>Suggested Keywords</h3>
                            ${suggested_keywords.map(keyword => `
                                <div class="suggestion-item">${keyword}</div>
                            `).join('')}
                        </div>
                        <div class="suggestion-section">
                            <h3>Action Verbs</h3>
                            ${action_verbs.map(verb => `
                                <div class="suggestion-item">${verb}</div>
                            `).join('')}
                        </div>
                        <div class="suggestion-section">
                            <h3>Optimization Advice</h3>
                            <p>${general_advice}</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('Analysis error:', error);
                    showToast('Failed to analyze job description', 'error');
                }
            }

            async function analyzeJobDescriptionForKeywords() {
                const jobDesc = els.analyzerJobDescTextarea.value.trim();
                if (!jobDesc) return showToast('Please enter a job description', 'error');

                const prompt = `Extract the most important keywords and skills from this job description that should be included in a resume. Return a JSON object with:
- keywords: Array of important keywords (nouns)
- skills: Array of technical and soft skills
- verbs: Array of action verbs used in the description

Job Description:
${jobDesc}`;

                els.analyzeDescriptionBtn.classList.add('ai-loading');
                const result = await generateWithAI(prompt);
                els.analyzeDescriptionBtn.classList.remove('ai-loading');

                try {
                    const { keywords, skills, verbs } = JSON.parse(result);
                    els.keywordResults.classList.remove('hidden');
                    
                    els.keywordResults.querySelector('.keyword-cloud').innerHTML = keywords
                        .slice(0, 15)
                        .map(keyword => `<span class="keyword">${keyword}</span>`)
                        .join('');
                    
                    els.keywordResults.querySelector('.suggested-skills').innerHTML = skills
                        .slice(0, 10)
                        .map(skill => `<span class="keyword">${skill}</span>`)
                        .join('');
                    
                    els.keywordResults.querySelector('.action-verbs').innerHTML = verbs
                        .slice(0, 10)
                        .map(verb => `<span class="keyword">${verb}</span>`)
                        .join('');
                } catch (error) {
                    console.error('Keyword extraction error:', error);
                    showToast('Failed to extract keywords', 'error');
                }
            }

            // PDF Export
            async function exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                try {
                    els.exportPdfBtn.textContent = 'Generating...';
                    
                    const canvas = await html2canvas(els.resumePreview, {
                        scale: 2,
                        logging: false,
                        useCORS: true
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = doc.internal.pageSize.getWidth();
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    
                    const name = resumeData.personal.fullName || 'resume';
                    const title = resumeData.personal.jobTitle || '';
                    const filename = `${name.replace(/\s+/g, '_')}_${title.replace(/\s+/g, '_')}_resume.pdf`.toLowerCase();
                    
                    doc.save(filename);
                    showToast('PDF exported successfully!');
                } catch (error) {
                    console.error('PDF export error:', error);
                    showToast('Error generating PDF', 'error');
                } finally {
                    els.exportPdfBtn.textContent = 'Export PDF';
                }
            }

            // Initialize Application
            document.addEventListener('DOMContentLoaded', init);

            // Public Methods for HTML Event Handlers
            window.removeSkill = (skill) => {
                resumeData.skills = resumeData.skills.filter(s => s !== skill);
                els.skillsList.querySelectorAll('.skill-tag').forEach(tag => {
                    if (tag.textContent.includes(skill)) tag.remove();
                });
                updateResumePreview();
                saveToStorage();
            };

            window.addSkill = (skill) => {
                if (!resumeData.skills.includes(skill)) {
                    resumeData.skills.push(skill);
                    addSkillTag(skill);
                    updateResumePreview();
                    saveToStorage();
                    showToast(`Added skill: ${skill}`);
                }
            };

            window.improveSummaryWithAI = async () => {
                if (!resumeData.summary) return showToast('Please create a summary first', 'error');
                
                const prompt = `Improve this resume summary to be more impactful and ATS-friendly. Keep it concise (3-4 sentences) and focus on achievements:\n\n${resumeData.summary}`;
                
                document.getElementById('professional-summary').classList.add('ai-loading');
                const improved = await generateWithAI(prompt);
                document.getElementById('professional-summary').classList.remove('ai-loading');
                
                if (improved) {
                    resumeData.summary = improved;
                    document.getElementById('professional-summary').value = improved;
                    updateResumePreview();
                    saveToStorage();
                    showToast('Summary improved with AI');
                }
            };

            window.enhanceExperienceWithAI = async (button) => {
                const experienceItem = button.closest('.experience-item');
                const textarea = experienceItem.querySelector('textarea');
                const currentText = textarea.value;
                
                const prompt = `Enhance this work experience description for a resume. Use strong action verbs and quantify achievements where possible. Keep it to 3-5 bullet points:\n\n${currentText}`;
                
                button.classList.add('ai-loading');
                const enhanced = await generateWithAI(prompt);
                button.classList.remove('ai-loading');

                if (enhanced) {
                    textarea.value = enhanced;
                    const id = experienceItem.dataset.id;
                    const experience = resumeData.experiences.find(e => e.id == id);
                    if (experience) {
                        experience.description = enhanced;
                        updateResumePreview();
                        saveToStorage();
                        showToast('Experience enhanced with AI');
                    }
                }
            };

            window.setApiKey = () => {
                const key = prompt('Enter your DeepSeek API key:');
                if (key) {
                    state.aiApiKey = key;
                    localStorage.setItem('aiApiKey', key);
                    showToast('API key saved');
                }
            };
        })();
    </script>
</body>
</html>




